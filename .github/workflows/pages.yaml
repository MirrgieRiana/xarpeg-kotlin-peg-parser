name: pages

on:
  push:
    branches:
      - main

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to find tags

      - name: Set version from git tags
        run: |
          # Determine version based on git tags
          # Check if HEAD has a version tag (pattern: v followed by digits and dots)
          HEAD_TAG=$(git tag --points-at HEAD | grep -E '^v[0-9]+(\.[0-9]+)*$' | head -n 1)
          
          if [ -n "$HEAD_TAG" ]; then
            # HEAD has a version tag, use it without 'v'
            VERSION="${HEAD_TAG#v}"
            echo "HEAD has version tag: $HEAD_TAG, using version: $VERSION"
          else
            # Find the most recent version tag reachable from HEAD
            # Try git describe first (finds tags in ancestry)
            LATEST_TAG=$(git describe --tags --abbrev=0 --match 'v[0-9]*' HEAD 2>/dev/null || echo "")
            
            if [ -z "$LATEST_TAG" ]; then
              # If describe failed, try to find tags on main branch ancestors
              # Get all version tags sorted by version
              LATEST_TAG=$(git tag -l 'v[0-9]*' --sort=-version:refname --merged HEAD 2>/dev/null | head -n 1)
            fi
            
            if [ -n "$LATEST_TAG" ]; then
              # Tag found, add suffix to indicate development version
              VERSION="${LATEST_TAG#v}-dev"
              echo "Latest version tag found: $LATEST_TAG, using version: $VERSION"
            else
              # No tags found, use 'latest'
              VERSION="latest"
              echo "No version tags found, using version: $VERSION"
            fi
          fi
          
          # Update the version in gradle/libs.versions.toml
          # Use | as delimiter to avoid issues with / or & in version strings
          # Escape special characters in VERSION for sed
          ESCAPED_VERSION=$(printf '%s\n' "$VERSION" | sed 's/[&/\]/\\&/g')
          sed -i "s|^xarpeg-version = .*|xarpeg-version = \"$ESCAPED_VERSION\"|" gradle/libs.versions.toml
          
          # Display the updated version
          echo "Updated gradle/libs.versions.toml with version: $VERSION"
          grep "xarpeg-version" gradle/libs.versions.toml

      - name: Set up JDK
        uses: actions/setup-java@v4.5.0
        with:
          distribution: temurin
          java-version: '17'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Build online parser sample
        run: |
          cd samples/online-parser
          ./gradlew build --console=plain --info --stacktrace

      - name: Bundle all Pages content
        run: ./gradlew bundleRelease --console=plain
        env:
          GRADLE_OPTS: "-Xmx2g -XX:MaxMetaspaceSize=512m"

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true
          working-directory: build/bundleRelease

      - name: Build site with Jekyll
        run: ./scripts/build-pages.sh ./build/site

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./build/site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
